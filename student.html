<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Sinh - L√†m B√†i</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #e0f7fa; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        select { width: 100%; padding: 15px; font-size: 1.1em; margin-bottom: 20px; border: 2px solid #009688; border-radius: 5px; }
        .post { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; background: #fff; border-radius: 8px; }
        .content { white-space: pre-wrap; font-family: 'Courier New', monospace; background: #fafafa; padding: 15px; border: 1px dashed #aaa; margin: 10px 0; }
        input, textarea, button { width: 100%; margin-top: 5px; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #009688; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 15px; }
        button:hover { background: #00796b; }
        
        /* K·∫øt qu·∫£ ch·∫•m ƒëi·ªÉm */
        .result-box { margin-top: 15px; padding: 15px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 5px; display: none; }
        .score { font-size: 1.2em; font-weight: bold; color: #2e7d32; }
        .correct-key { color: #c0392b; font-weight: bold; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#00796b;">üë®‚Äçüéì KHU V·ª∞C H·ªåC SINH</h2>
    <select id="class-select" onchange="loadAss()"><option value="">-- ƒêang t·∫£i danh s√°ch l·ªõp... --</option></select>
    <div id="ass-area"><p style="text-align:center">Vui l√≤ng ch·ªçn l·ªõp.</p></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // --- C·∫§U H√åNH ---
    const firebaseConfig = {
      apiKey: "AIzaSyDjSb3byp5-SMUdJU5XDnGXwKEUOLXI6JE",
      authDomain: "lophoconl.firebaseapp.com",
      databaseURL: "https://lophoconl-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "lophoconl",
      storageBucket: "lophoconl.firebasestorage.app",
      messagingSenderId: "1051247561864",
      appId: "1:1051247561864:web:43886eee9886cafd59a33d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Load L·ªõp
    onValue(ref(db, 'classes'), snap => {
        const sel = document.getElementById('class-select');
        sel.innerHTML = '<option value="">-- Ch·ªçn l·ªõp c·ªßa em --</option>';
        const d = snap.val();
        if(d) Object.keys(d).forEach(k => sel.innerHTML += `<option value="${k}">${d[k].name}</option>`);
    });

    // Load B√†i t·∫≠p
    window.loadAss = () => {
        const cid = document.getElementById('class-select').value;
        const area = document.getElementById('ass-area');
        if(!cid) return area.innerHTML = "";
        
        area.innerHTML = "<i>ƒêang t·∫£i b√†i t·∫≠p...</i>";
        
        onValue(ref(db, `assignments/${cid}`), snap => {
            area.innerHTML = "";
            const d = snap.val();
            if(!d) return area.innerHTML = "<p>L·ªõp n√†y ch∆∞a c√≥ b√†i t·∫≠p n√†o.</p>";

            Object.keys(d).reverse().forEach(k => {
                const q = d[k];
                // L∆∞u ƒë√°p √°n ƒë√∫ng v√†o thu·ªôc t√≠nh data-key ƒë·ªÉ d√πng sau (n·∫øu c√≥)
                const keyAttr = q.correctAnswer ? `data-key="${q.correctAnswer}"` : "";
                
                area.innerHTML += `
                    <div class="post" id="post-${k}">
                        <h3>${q.title}</h3>
                        <div class="content">${q.content}</div>
                        <hr>
                        <input type="text" id="name-${k}" placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa em...">
                        <textarea id="ans-${k}" rows="3" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi (VD: 1A 2B 3C...)"></textarea>
                        
                        <button onclick="submit('${cid}', '${k}')" ${keyAttr}>N·ªòP B√ÄI</button>
                        
                        <div id="res-${k}" class="result-box"></div>
                    </div>`;
            });
        });
    }

    // N·ªôp b√†i & Ch·∫•m ƒëi·ªÉm
    window.submit = (cid, aid) => {
        const name = document.getElementById(`name-${aid}`).value;
        const ans = document.getElementById(`ans-${aid}`).value;
        // L·∫•y ƒë√°p √°n ƒë√∫ng t·ª´ n√∫t b·∫•m (ƒë√£ l∆∞u l√∫c t·∫£i trang)
        const btn = document.querySelector(`#post-${aid} button`);
        const correctKey = btn.getAttribute('data-key'); 

        if(!name || !ans) return alert("Em ch∆∞a ƒëi·ªÅn t√™n ho·∫∑c c√¢u tr·∫£ l·ªùi!");

        // 1. L∆∞u b√†i l√†m l√™n Firebase
        push(ref(db, `answers/${cid}/${aid}`), {
            name: name, answer: ans, timestamp: Date.now()
        });

        // 2. Logic Ch·∫•m ƒëi·ªÉm (So s√°nh chu·ªói)
        let msg = "ƒê√£ n·ªôp b√†i th√†nh c√¥ng!";
        if(correctKey) {
            // T√°ch chu·ªói th√†nh m·∫£ng c√°c t·ª´ (VD: "1A 2B" -> ["1A", "2B"])
            // D√πng Regex ƒë·ªÉ t√°ch b·ªè d·∫•u ch·∫•m, ph·∫©y, kho·∫£ng tr·∫Øng th·ª´a
            const studentTokens = ans.match(/[a-zA-Z0-9]+/g) || [];
            const keyTokens = correctKey.match(/[a-zA-Z0-9]+/g) || [];
            
            let matchCount = 0;
            // So s√°nh ƒë∆°n gi·∫£n: ƒë·∫øm xem c√≥ bao nhi√™u token c·ªßa HS tr√πng v·ªõi ƒë√°p √°n
            // (Chuy·ªÉn v·ªÅ ch·ªØ hoa ƒë·ªÉ so s√°nh kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng)
            studentTokens.forEach(token => {
                if(keyTokens.map(k => k.toUpperCase()).includes(token.toUpperCase())) {
                    matchCount++;
                }
            });

            // T√≠nh ph·∫ßn trƒÉm (T∆∞∆°ng ƒë·ªëi)
            const total = keyTokens.length;
            const percent = total > 0 ? Math.round((matchCount / total) * 100) : 0;
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            const resBox = document.getElementById(`res-${aid}`);
            resBox.style.display = "block";
            resBox.innerHTML = `
                <div class="score">K·∫øt qu·∫£ t·ª± ƒë·ªông: Tr√πng kh·ªõp kho·∫£ng ${matchCount}/${total} c√¢u (${percent}%)</div>
                <div class="correct-key">ƒê√°p √°n ƒë√∫ng c·ªßa th·∫ßy c√¥: ${correctKey}</div>
                <div><i>(Em h√£y ƒë·ªëi chi·∫øu l·∫°i b√†i l√†m c·ªßa m√¨nh v·ªõi ƒë√°p √°n tr√™n nh√©!)</i></div>
            `;
            
            msg = "ƒê√£ n·ªôp b√†i! Em xem k·∫øt qu·∫£ ch·∫•m ·ªü b√™n d∆∞·ªõi nh√©.";
        }
        
        alert(msg);
    }
</script>
</body>
</html>