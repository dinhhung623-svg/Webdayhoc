<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học Sinh - Làm Bài Thi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* GIAO DIỆN NỀN XÁM GIỐNG WORD */
        body { font-family: 'Segoe UI', sans-serif; background: #e0e0e0; padding: 20px; margin: 0; }
        
        .container { 
            max-width: 1000px; /* Tăng độ rộng lên */
            margin: 0 auto; 
            background: transparent; /* Container trong suốt */
        }

        /* HEADER */
        .header-section {
            background: white; padding: 20px; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 30px;
            text-align: center;
        }

        select { width: 100%; padding: 12px; font-size: 1.1em; border: 2px solid #009688; border-radius: 5px; max-width: 400px;}
        
        /* HIỆU ỨNG TỜ GIẤY A4 CHO ĐỀ BÀI */
        .post { 
            background: white; 
            padding: 40px 50px; /* Lề giấy rộng */
            margin-bottom: 40px; 
            border-radius: 2px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); /* Bóng đổ nổi */
            position: relative;
        }

        /* ĐỊNH DẠNG VĂN BẢN GIỐNG WORD */
        .content { 
            white-space: pre-wrap; /* Giữ nguyên xuống dòng/dấu cách */
            font-family: 'Times New Roman', Times, serif; /* Font chữ Word */
            font-size: 14pt; /* Cỡ chữ chuẩn văn bản */
            line-height: 1.6; /* Giãn dòng */
            color: #000;
            background: transparent;
            border: none;
            padding: 0;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        /* TIÊU ĐỀ BÀI TẬP */
        h3 { 
            color: #2c3e50; font-size: 18pt; margin-top: 0; 
            border-bottom: 2px solid #eee; padding-bottom: 15px; 
        }

        /* PHẦN NHẬP TÊN VÀ NÚT BẤM */
        .student-input-area {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 30px;
        }

        /* PHIẾU TRẢ LỜI */
        .answer-sheet { background: white; padding: 15px; border-radius: 8px; border: 2px solid #c5e1a5; margin-top: 15px; }
        .sheet-title { font-weight: bold; margin-bottom: 10px; color: #33691e; text-align: center; text-transform: uppercase; }
        .question-row { display: flex; align-items: center; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .q-num { width: 30px; font-weight: bold; color: #555; }
        
        .option-btn {
            width: 35px; height: 35px; border-radius: 50%; border: 1px solid #bbb;
            background: #fff; margin-right: 15px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; font-weight: bold; color: #555;
            transition: 0.2s; box-shadow: 0 2px 2px rgba(0,0,0,0.05);
        }
        .option-btn:hover { background: #f0f0f0; border-color: #888; }
        .option-btn.selected { background: #009688; color: white; border-color: #00796b; transform: scale(1.15); box-shadow: 0 2px 5px rgba(0,150,136,0.4); }

        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em;}
        button.submit-btn { background: #2980b9; color: white; border: none; font-weight: bold; cursor: pointer; padding: 15px; width: 100%; font-size: 1.1em; border-radius: 4px; box-shadow: 0 4px 6px rgba(41, 128, 185, 0.3); transition: 0.3s;}
        button.submit-btn:hover { background: #2471a3; transform: translateY(-2px); }
        button.submit-btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }

        .result-box { margin-top: 20px; padding: 20px; background: #fffde7; border: 2px solid #ffb74d; border-radius: 8px; display: none; text-align: center; }
        .score { font-size: 1.8em; font-weight: bold; color: #e65100; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h2 style="color:#2980b9; margin:0 0 15px 0;"><i class="fas fa-file-alt"></i> HỆ THỐNG THI TRỰC TUYẾN</h2>
        <select id="class-select" onchange="loadAss()"><option value="">-- Đang tải danh sách lớp... --</option></select>
    </div>
    
    <div id="ass-area">
        <div style="text-align:center; color:#777; margin-top: 50px;">
            <i class="fas fa-arrow-up"></i><br>Vui lòng chọn lớp để lấy đề thi.
        </div>
    </div>
</div>

<script type="module">
    // ... (GIỮ NGUYÊN PHẦN SCRIPT JAVASCRIPT CŨ CỦA BẠN - KHÔNG CẦN SỬA CODE JS) ...
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDjSb3byp5-SMUdJU5XDnGXwKEUOLXI6JE",
      authDomain: "lophoconl.firebaseapp.com",
      databaseURL: "https://lophoconl-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "lophoconl",
      storageBucket: "lophoconl.firebasestorage.app",
      messagingSenderId: "1051247561864",
      appId: "1:1051247561864:web:43886eee9886cafd59a33d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    onValue(ref(db, 'classes'), snap => {
        const sel = document.getElementById('class-select');
        sel.innerHTML = '<option value="">-- Chọn lớp của em --</option>';
        const d = snap.val();
        if(d) Object.keys(d).forEach(k => sel.innerHTML += `<option value="${k}">${d[k].name}</option>`);
    });

    window.loadAss = () => {
        const cid = document.getElementById('class-select').value;
        const area = document.getElementById('ass-area');
        if(!cid) return area.innerHTML = "";
        
        area.innerHTML = "<div style='text-align:center; padding: 50px;'><i class='fas fa-spinner fa-spin fa-2x'></i><br>Đang tải đề thi...</div>";
        
        onValue(ref(db, `assignments/${cid}`), snap => {
            area.innerHTML = "";
            const d = snap.val();
            if(!d) return area.innerHTML = "<div style='text-align:center; padding:50px'>Chưa có bài kiểm tra nào.</div>";

            Object.keys(d).reverse().forEach(k => {
                const q = d[k];
                const keyTokens = q.correctAnswer ? q.correctAnswer.match(/[a-zA-Z0-9]+/g) : [];
                const numQuestions = keyTokens ? keyTokens.length : 0;
                const keyAttr = q.correctAnswer ? `data-key="${q.correctAnswer}"` : "";

                let sheetHTML = `<div class="answer-sheet" id="sheet-${k}">`;
                if(numQuestions > 0) {
                    sheetHTML += `<div class="sheet-title">Phiếu Trả Lời (${numQuestions} Câu)</div>`;
                    for(let i=1; i<=numQuestions; i++) {
                        sheetHTML += `
                            <div class="question-row" id="qrow-${k}-${i}">
                                <div class="q-num">${i}.</div>
                                <div class="option-btn" onclick="selectOpt('${k}', ${i}, 'A')">A</div>
                                <div class="option-btn" onclick="selectOpt('${k}', ${i}, 'B')">B</div>
                                <div class="option-btn" onclick="selectOpt('${k}', ${i}, 'C')">C</div>
                                <div class="option-btn" onclick="selectOpt('${k}', ${i}, 'D')">D</div>
                            </div>
                        `;
                    }
                } else {
                    sheetHTML += "<p style='color:red'>Chưa có phiếu trả lời.</p>";
                }
                sheetHTML += `</div>`;

                area.innerHTML += `
                    <div class="post" id="post-${k}">
                        <h3>${q.title}</h3>
                        
                        <div class="content">${q.content}</div>
                        
                        <div class="student-input-area">
                            <label><b>Họ và tên học sinh:</b></label>
                            <input type="text" id="name-${k}" placeholder="Nhập tên của em...">
                            
                            ${sheetHTML}
                            
                            <button class="submit-btn" onclick="submit('${cid}', '${k}')" ${keyAttr}>NỘP BÀI THI</button>
                            <div id="res-${k}" class="result-box"></div>
                        </div>
                    </div>`;
            });
        });
    }

    window.selectOpt = function(assId, qNum, opt) {
        const row = document.getElementById(`qrow-${assId}-${qNum}`);
        const btns = row.getElementsByClassName('option-btn');
        for(let btn of btns) btn.classList.remove('selected');
        for(let btn of btns) if(btn.innerText === opt) {
            btn.classList.add('selected');
            row.setAttribute('data-selected', opt);
        }
    }

    window.submit = (cid, aid) => {
        const name = document.getElementById(`name-${aid}`).value;
        const btn = document.querySelector(`#post-${aid} .submit-btn`);
        const correctKey = btn.getAttribute('data-key'); 

        if(!name) return alert("Em vui lòng nhập tên trước khi nộp bài!");

        const sheet = document.getElementById(`sheet-${aid}`);
        const rows = sheet.getElementsByClassName('question-row');
        let studentAnsString = "";
        let ansArray = [];

        for(let i=0; i<rows.length; i++) {
            const qNum = i + 1;
            const selected = rows[i].getAttribute('data-selected');
            if(selected) {
                ansArray.push(selected);
                studentAnsString += `${qNum}${selected} `;
            } else {
                studentAnsString += `${qNum}? `;
                ansArray.push("?"); 
            }
        }

        let scoreText = "0";
        let percent = 0;
        let msg = "";

        if(correctKey) {
            const cleanKey = correctKey.match(/[a-dA-D]/g) || [];
            let matchCount = 0;
            for(let i=0; i<cleanKey.length; i++) {
                if(ansArray[i] && ansArray[i].toUpperCase() === cleanKey[i].toUpperCase()) {
                    matchCount++;
                }
            }
            const total = cleanKey.length;
            percent = total > 0 ? Math.round((matchCount / total) * 100) : 0;
            scoreText = `${matchCount}/${total}`;
            msg = `<div class="score">Điểm số: ${scoreText} (${percent}%)</div>
                   <div style="text-align:center; margin-top:10px;">Đáp án đúng: <b>${correctKey}</b></div>`;
        }

        push(ref(db, `answers/${cid}/${aid}`), {
            name: name,
            answer: studentAnsString.trim(),
            score: scoreText,
            percent: percent,
            timestamp: Date.now()
        });

        const resBox = document.getElementById(`res-${aid}`);
        resBox.style.display = "block";
        resBox.innerHTML = `✅ <b>${name}</b> đã nộp bài thành công!<br>${msg}`;
        
        btn.disabled = true;
        btn.innerHTML = "<i class='fas fa-check-circle'></i> ĐÃ NỘP BÀI XONG";
        btn.style.background = "#7f8c8d";
    }
</script>
</body>
</html>