<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học Sinh - Làm Bài</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #e0f7fa; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        select { width: 100%; padding: 15px; font-size: 1.1em; margin-bottom: 20px; border: 2px solid #009688; border-radius: 5px; }
        
        .post { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; background: #fff; border-radius: 8px; border-top: 5px solid #009688; }
        .content { white-space: pre-wrap; font-family: 'Courier New', monospace; background: #fafafa; padding: 15px; border: 1px dashed #aaa; margin: 10px 0; font-size: 0.95em; }
        
        input, textarea, button { width: 100%; margin-top: 5px; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #009688; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 1em; }
        button:hover { background: #00796b; }
        
        .result-box { margin-top: 15px; padding: 15px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 5px; display: none; }
        .score { font-size: 1.2em; font-weight: bold; color: #2e7d32; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#00796b;"><i class="fas fa-user-graduate"></i> KHU VỰC HỌC SINH</h2>
    <select id="class-select" onchange="loadAss()"><option value="">-- Đang tải danh sách lớp... --</option></select>
    <div id="ass-area"><p style="text-align:center; color: #666">Vui lòng chọn lớp để xem bài tập.</p></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // --- CẤU HÌNH FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDjSb3byp5-SMUdJU5XDnGXwKEUOLXI6JE",
      authDomain: "lophoconl.firebaseapp.com",
      databaseURL: "https://lophoconl-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "lophoconl",
      storageBucket: "lophoconl.firebasestorage.app",
      messagingSenderId: "1051247561864",
      appId: "1:1051247561864:web:43886eee9886cafd59a33d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 1. Load danh sách lớp
    onValue(ref(db, 'classes'), snap => {
        const sel = document.getElementById('class-select');
        sel.innerHTML = '<option value="">-- Chọn lớp của em --</option>';
        const d = snap.val();
        if(d) Object.keys(d).forEach(k => sel.innerHTML += `<option value="${k}">${d[k].name}</option>`);
    });

    // 2. Load Bài tập
    window.loadAss = () => {
        const cid = document.getElementById('class-select').value;
        const area = document.getElementById('ass-area');
        if(!cid) return area.innerHTML = "<p style='text-align:center'>Vui lòng chọn lớp.</p>";
        
        area.innerHTML = "<div style='text-align:center'><i class='fas fa-spinner fa-spin'></i> Đang tải bài tập...</div>";
        
        onValue(ref(db, `assignments/${cid}`), snap => {
            area.innerHTML = "";
            const d = snap.val();
            if(!d) return area.innerHTML = "<p style='text-align:center'>Lớp này chưa có bài tập nào.</p>";

            Object.keys(d).reverse().forEach(k => {
                const q = d[k];
                // Lưu đáp án đúng vào data-key để dùng khi chấm
                const keyAttr = q.correctAnswer ? `data-key="${q.correctAnswer}"` : "";
                
                area.innerHTML += `
                    <div class="post" id="post-${k}">
                        <h3>${q.title}</h3>
                        <div class="content">${q.content}</div>
                        <hr>
                        <div><b>Bài làm của em:</b></div>
                        <input type="text" id="name-${k}" placeholder="Nhập Họ và Tên (Bắt buộc)">
                        <textarea id="ans-${k}" rows="3" placeholder="Nhập đáp án (VD: 1A 2B 3C...)"></textarea>
                        
                        <button onclick="submit('${cid}', '${k}')" ${keyAttr}><i class="fas fa-paper-plane"></i> NỘP BÀI</button>
                        
                        <div id="res-${k}" class="result-box"></div>
                    </div>`;
            });
        });
    }

    // 3. Nộp bài & Chấm điểm & Lưu kết quả
    window.submit = (cid, aid) => {
        const name = document.getElementById(`name-${aid}`).value;
        const ans = document.getElementById(`ans-${aid}`).value;
        const btn = document.querySelector(`#post-${aid} button`);
        const correctKey = btn.getAttribute('data-key'); 

        if(!name || !ans) return alert("Em chưa điền tên hoặc câu trả lời!");

        // --- Logic Chấm điểm ---
        let scoreText = "Chưa chấm"; // Mặc định nếu thầy cô không nhập key
        let percent = 0;

        if(correctKey) {
            // Tách chuỗi thành mảng, loại bỏ ký tự lạ
            const studentTokens = ans.match(/[a-zA-Z0-9]+/g) || [];
            const keyTokens = correctKey.match(/[a-zA-Z0-9]+/g) || [];
            
            let matchCount = 0;
            // So sánh từng đáp án (không phân biệt hoa thường)
            studentTokens.forEach(token => {
                if(keyTokens.map(k => k.toUpperCase()).includes(token.toUpperCase())) {
                    matchCount++;
                }
            });

            const total = keyTokens.length;
            percent = total > 0 ? Math.round((matchCount / total) * 100) : 0;
            scoreText = `${matchCount}/${total}`; // Ví dụ: "8/10"
        }

        // --- Lưu vào Firebase ---
        push(ref(db, `answers/${cid}/${aid}`), {
            name: name,
            answer: ans,
            score: scoreText, // Lưu điểm số vừa tính
            percent: percent, // Lưu phần trăm để thầy cô dễ nhìn
            timestamp: Date.now()
        });

        // --- Hiển thị kết quả cho học sinh ---
        const resBox = document.getElementById(`res-${aid}`);
        resBox.style.display = "block";
        
        let msg = `✅ Đã nộp bài thành công!`;
        if(correctKey) {
            msg += `<br><br>
            <div class="score">Kết quả: ${scoreText} câu đúng (${percent}%)</div>
            <div style="margin-top:5px; color:#555">Đáp án gốc: <b>${correctKey}</b></div>`;
        }
        resBox.innerHTML = msg;
        
        // Khóa nút nộp để tránh spam
        btn.disabled = true;
        btn.innerHTML = "ĐÃ NỘP XONG";
        btn.style.background = "#7f8c8d";
    }
</script>
</body>
</html>