<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi√°o Vi√™n - So·∫°n B√†i ƒê·ªçc üìñ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; background: #f0f2f5; }
        .sidebar { width: 260px; background: #2c3e50; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .class-item { padding: 12px 15px; margin: 5px 10px; background: #34495e; border-radius: 6px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .class-item:hover { background: #16a085; }
        .class-item.active { background: #27ae60; font-weight: bold; border-left: 4px solid #fff; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #ecf0f1; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .tab-btn { padding: 10px 20px; border: none; background: #eee; border-radius: 20px; cursor: pointer; font-weight: bold; color: #555; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .tab-btn.active { background: #8e44ad; color: white; box-shadow: 0 4px 10px rgba(142, 68, 173, 0.3); }

        /* CLOZE TEST STYLES */
        .cloze-area { display: flex; gap: 20px; }
        .cloze-left { flex: 1; }
        .cloze-right { flex: 1; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        
        .passage-input {
            width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 4px;
            font-family: 'Times New Roman', serif; font-size: 1.1em; line-height: 1.6; resize: vertical;
        }
        
        .q-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-save { background: #d35400; color: white; padding: 15px; width: 100%; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1em; cursor: pointer; margin-top: 20px; }
        
        /* Manual Card Small */
        .manual-card { background: white; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-left: 3px solid #8e44ad; border-radius: 4px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="padding:20px; background:#1a252f; color:white;"><h3><i class="fas fa-chalkboard-teacher"></i> Gi√°o Vi√™n</h3></div>
    <div id="class-list" style="padding:10px;"></div>
    <div style="padding:10px"><button onclick="addClass()" style="width:100%; padding:12px; background:#e67e22; border:none; color:white; font-weight:bold; border-radius:4px;">+ L·ªõp M·ªõi</button></div>
</div>

<div class="main-content">
    <div id="welcome-msg" style="text-align:center; margin-top:100px; color:#7f8c8d;"><h2>‚¨ÖÔ∏è Ch·ªçn l·ªõp ƒë·ªÉ b·∫Øt ƒë·∫ßu</h2></div>

    <div id="manager" class="hidden container">
        <h2 style="margin-top:0; color:#2c3e50;">So·∫°n ƒê·ªÅ: <span id="class-name" style="color:#e67e22">...</span></h2>
        <input type="text" id="a-title" class="q-input" placeholder="T√™n b√†i thi..." style="font-weight:bold; font-size:1.1em;">

        <div class="tabs">
            <button class="tab-btn" onclick="switchMode('normal')" id="tab-normal"><i class="fas fa-list-ol"></i> Tr·∫Øc Nghi·ªám Th∆∞·ªùng</button>
            <button class="tab-btn active" onclick="switchMode('cloze')" id="tab-cloze"><i class="fas fa-paragraph"></i> B√†i ƒê·ªçc ƒêi·ªÅn T·ª´</button>
        </div>

        <div id="mode-normal" class="hidden">
            <p><i>Chuy·ªÉn sang tab "B√†i ƒê·ªçc ƒêi·ªÅn T·ª´" ƒë·ªÉ so·∫°n d·∫°ng k√©o th·∫£.</i></p>
        </div>

        <div id="mode-cloze">
            <div class="cloze-area">
                <div class="cloze-left">
                    <h4 style="margin-top:0"><i class="fas fa-file-alt"></i> 1. N·ªôi dung ƒëo·∫°n vƒÉn</h4>
                    <p style="font-size:0.9em; color:#666">Copy ƒëo·∫°n vƒÉn v√†o ƒë√¢y. H√£y ƒë·∫£m b·∫£o c√°c v·ªã tr√≠ ƒëi·ªÅn t·ª´ c√≥ d·∫°ng s·ªë trong ngo·∫∑c ho·∫∑c g·∫°ch d∆∞·ªõi. VD: <b>(6)____</b> ho·∫∑c <b>[6]</b>.</p>
                    <textarea id="passage-text" class="passage-input" placeholder="Paste ƒëo·∫°n vƒÉn v√†o ƒë√¢y... V√≠ d·ª•: It could be a future science fiction film. (6)____, it is very real..."></textarea>
                </div>
                
                <div class="cloze-right">
                    <h4 style="margin-top:0"><i class="fas fa-database"></i> 2. C√°c c√¢u h·ªèi & ƒê√°p √°n</h4>
                    <p style="font-size:0.9em; color:#666">Paste danh s√°ch c√¢u h·ªèi tr·∫Øc nghi·ªám v√†o ƒë√¢y ƒë·ªÉ h·ªá th·ªëng t·ª± t√°ch.</p>
                    <textarea id="cloze-questions-raw" class="passage-input" style="height:150px" placeholder="V√≠ d·ª•:&#10;Question 6. A. However B. But C. Although D. Though&#10;Question 7. ..."></textarea>
                    <button onclick="parseClozeData()" style="width:100%; background:#8e44ad; color:white; border:none; padding:8px; margin-top:10px; cursor:pointer; font-weight:bold; border-radius:4px">Ph√¢n t√≠ch & Kh·ªõp</button>
                </div>
            </div>

            <div id="cloze-preview" style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                </div>
        </div>

        <button class="btn-save" onclick="saveAssignment()">L∆ØU B√ÄI T·∫¨P</button>
        <div style="margin-top:20px; border-top:1px solid #ccc; padding-top:10px;">
            <h3>Danh s√°ch b√†i ƒë√£ t·∫°o:</h3>
            <div id="list"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    
    const firebaseConfig = { apiKey: "AIzaSyDjSb3byp5-SMUdJU5XDnGXwKEUOLXI6JE", authDomain: "lophoconl.firebaseapp.com", databaseURL: "https://lophoconl-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "lophoconl", storageBucket: "lophoconl.firebasestorage.app", messagingSenderId: "1051247561864", appId: "1:1051247561864:web:43886eee9886cafd59a33d" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let curClass = null;
    let currentMode = 'cloze';
    let finalClozeData = { passage: "", questions: {} };

    window.switchMode = (mode) => {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${mode}`).classList.add('active');
        document.getElementById('mode-normal').classList.toggle('hidden', mode !== 'normal');
        document.getElementById('mode-cloze').classList.toggle('hidden', mode !== 'cloze');
    }

    // --- LOGIC X·ª¨ L√ù B√ÄI ƒê·ªåC (CLOZE PARSER) ---
    window.parseClozeData = () => {
        const passage = document.getElementById('passage-text').value;
        const rawQ = document.getElementById('cloze-questions-raw').value;
        
        if(!passage || !rawQ) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß ƒêo·∫°n vƒÉn v√† C√¢u h·ªèi!");

        // 1. X·ª≠ l√Ω c√¢u h·ªèi (D√πng l·∫°i logic smart import)
        const lines = rawQ.split('\n');
        let questions = {};
        let currentQNum = null;

        lines.forEach(line => {
            line = line.trim();
            // T√¨m s·ªë c√¢u h·ªèi: "Question 6" ho·∫∑c "C√¢u 6" ho·∫∑c "6."
            const qMatch = line.match(/^(Question|C√¢u|B√†i)?\s*(\d+)[\.:\)]/i);
            if(qMatch) {
                currentQNum = qMatch[2]; // S·ªë 6
                questions[currentQNum] = { options: [], correct: "A" }; // M·∫∑c ƒë·ªãnh A
            }
            
            // T√¨m ƒë√°p √°n A, B, C, D tr√™n d√≤ng
            if(currentQNum) {
                // T√°ch A. ... B. ...
                const parts = line.split(/(?:\s+|^)([A-D])[\.:\)]\s+/);
                for (let i = 1; i < parts.length; i += 2) {
                    const label = parts[i].toUpperCase();
                    let val = parts[i+1].trim();
                    if(val) questions[currentQNum].options.push(`${label}. ${val}`);
                }
            }
        });

        // 2. Hi·ªÉn th·ªã Review
        const preview = document.getElementById('cloze-preview');
        preview.innerHTML = "<h4>K·∫øt qu·∫£ kh·ªõp d·ªØ li·ªáu:</h4>";
        
        // Highlight ƒëo·∫°n vƒÉn: Thay (6)____ th√†nh [√î TR·ªêNG 6]
        let displayPassage = passage.replace(/(\(\d+\)_{2,}|\[\d+\])/g, (match) => {
            return `<span style="background:#e8f0fe; color:#1a73e8; font-weight:bold; padding:0 5px; border-radius:4px">${match}</span>`;
        });
        
        preview.innerHTML += `<div style="background:#fff; padding:10px; border:1px solid #eee; margin-bottom:10px; font-family:'Times New Roman'">${displayPassage}</div>`;

        Object.keys(questions).forEach(num => {
            const q = questions[num];
            preview.innerHTML += `
                <div class="manual-card">
                    <b>C√¢u ${num}</b>: 
                    ${q.options.map(o => `<span style="background:#eee; padding:2px 6px; margin-right:5px; border-radius:4px">${o}</span>`).join('')}
                </div>`;
        });

        finalClozeData = { passage: passage, questions: questions };
        alert("ƒê√£ ph√¢n t√≠ch xong! H√£y ki·ªÉm tra l·∫°i r·ªìi b·∫•m L∆∞u.");
    }

    window.saveAssignment = () => {
        if(!curClass) return alert("Ch∆∞a ch·ªçn l·ªõp!");
        const title = document.getElementById('a-title').value;
        
        if(currentMode === 'cloze') {
            if(!finalClozeData.passage) return alert("Ch∆∞a ph√¢n t√≠ch b√†i ƒë·ªçc!");
            push(ref(db, `assignments/${curClass}`), {
                title: title || "B√†i ƒë·ªçc ƒëi·ªÅn t·ª´",
                type: 'cloze', // ƒê√°nh d·∫•u lo·∫°i b√†i
                data: JSON.stringify(finalClozeData),
                timestamp: Date.now()
            });
        }
        // ... (Logic normal mode c≈© n·∫øu c·∫ßn)
        
        alert("L∆∞u th√†nh c√¥ng!");
    }

    // C√°c h√†m qu·∫£n l√Ω l·ªõp, load danh s√°ch gi·ªØ nguy√™n nh∆∞ c≈©...
    window.addClass = () => { const n = prompt("T√™n l·ªõp:"); if(n) push(ref(db, 'classes'), {name: n}); }
    onValue(ref(db, 'classes'), snap => {
        const l = document.getElementById('class-list'); l.innerHTML = "";
        const d = snap.val(); if(d) Object.keys(d).forEach(k => {
            l.innerHTML += `<div class="class-item" onclick="curClass='${k}'; document.getElementById('manager').classList.remove('hidden'); document.getElementById('class-name').innerText='${d[k].name}'; loadAss('${k}')">${d[k].name}</div>`;
        });
    });
    window.loadAss = (k) => {
        onValue(ref(db, `assignments/${k}`), snap => {
            const l = document.getElementById('list'); l.innerHTML = "";
            const d = snap.val(); if(d) Object.keys(d).reverse().forEach(aid => {
                l.innerHTML += `<div style="background:white; padding:10px; margin-bottom:5px; border-radius:5px">${d[aid].title} <button onclick="remove(ref(db, 'assignments/${k}/${aid}'))" style="float:right;color:red;border:none;cursor:pointer">X√≥a</button></div>`;
            });
        });
    }
</script>
</body>
</html>