<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giáo Viên - AI Tách Đề Chi Tiết</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; background: #f0f2f5; }
        .sidebar { width: 280px; background: #2c3e50; color: white; display: flex; flex-direction: column; }
        .class-item { padding: 12px; margin: 5px; background: #34495e; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; color: white;}
        .class-item:hover, .class-item.active { background: #16a085; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #ecf0f1; }
        .editor-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 1000px; margin: 0 auto 30px auto; }
        .ai-section { background: #e8f5e9; padding: 20px; border-radius: 12px; border: 1px solid #a5d6a7; margin-bottom: 25px; text-align: center; }
        .btn-ai { background: #43a047; color: white; padding: 12px 40px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }
        #ai-status { margin-top: 15px; color: #1b5e20; font-weight: 500; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-primary { background: #2c3e50; color: white; padding: 12px; width: 100%; font-weight: bold; border:none; cursor: pointer; margin-top:15px; }
        #editor-container { height: 200px; background: white; }
        .key-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; background: #fafafa; padding: 10px; border: 1px solid #eee; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="padding:20px; background:#1a252f; color:white;"><h3>Giáo Viên</h3></div>
    <div id="class-list" style="padding:10px;"></div>
    <button onclick="addClass()" style="width:100%; padding:15px; background:#e67e22; border:none; color:white; font-weight:bold;">+ Thêm Lớp</button>
</div>

<div class="main-content">
    <div id="manager" class="hidden">
        <h2 id="class-name" style="color:#2c3e50;"></h2>
        
        <div class="editor-box">
            <h3 style="margin-top:0; color:#2e7d32;">Nhập đề thi (Word/Text)</h3>
            <div id="editor-container"></div>
            
            <div class="ai-section" style="margin-top: 20px;">
                <input type="text" id="gemini-key-input" placeholder="Dán API Key Google Gemini vào đây (nếu chưa lưu)" style="margin-bottom:10px;">
                <button id="btn-ai-trigger" class="btn-ai" onclick="processTextDetailed()">
                    <i class="fas fa-bolt"></i> AI Tách & Giải Đề
                </button>
                <div id="ai-status">Dán nội dung đề vào khung trên rồi bấm nút này.</div>
            </div>

            <input type="text" id="a-title" placeholder="Tiêu đề bài tập">
            
            <div style="margin-top: 20px;">
                <label><b>✅ Kết quả phân tích (AI):</b></label>
                <div id="key-container" style="margin-top:10px; border:1px solid #eee; padding:10px; max-height:400px; overflow-y:auto;"></div>
            </div>

            <button class="btn-primary" onclick="addAssignment()">LƯU BÀI TẬP</button>
        </div>
        <div id="list"></div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    
    const firebaseConfig = { apiKey: "AIzaSyDjSb3byp5-SMUdJU5XDnGXwKEUOLXI6JE", authDomain: "lophoconl.firebaseapp.com", databaseURL: "https://lophoconl-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "lophoconl", storageBucket: "lophoconl.firebasestorage.app", messagingSenderId: "1051247561864", appId: "1:1051247561864:web:43886eee9886cafd59a33d" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let curClass = null;
    let extractedData = {}; // Dữ liệu đã tách

    var quill = new Quill('#editor-container', { theme: 'snow', placeholder: 'Dán toàn bộ nội dung đề thi vào đây...' });

    // --- LOGIC AI TÁCH ĐỀ ---
    window.processTextDetailed = async () => {
        let key = document.getElementById('gemini-key-input').value.trim();
        if(!key) key = localStorage.getItem("MY_GEMINI_KEY");
        if(!key) return alert("Cần nhập API Key!");
        localStorage.setItem("MY_GEMINI_KEY", key);

        const text = quill.getText();
        if(text.length < 10) return alert("Chưa có nội dung đề!");

        const btn = document.getElementById('btn-ai-trigger');
        const status = document.getElementById('ai-status');
        btn.innerHTML = "Đang phân tích..."; btn.disabled = true;
        status.innerText = "Đang tách câu hỏi và đáp án...";

        const prompt = `
            Phân tích đề thi sau và trả về JSON.
            ĐỀ BÀI: """${text}"""
            
            YÊU CẦU OUTPUT JSON (Duy nhất):
            {
                "title": "Tên bài thi (tự đặt)",
                "questions": {
                    "1": { 
                        "content": "Nội dung câu hỏi (bỏ đáp án)", 
                        "options": ["A. Đáp án A", "B. Đáp án B", "C. Đáp án C", "D. Đáp án D"], 
                        "correct": "A" 
                    },
                    "2": { ... }
                }
            }
        `;

        try {
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await resp.json();
            const jsonStr = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            const result = JSON.parse(jsonStr);

            document.getElementById('a-title').value = result.title || "";
            extractedData = result.questions;
            
            // Render preview
            const cont = document.getElementById('key-container');
            cont.innerHTML = "";
            Object.keys(extractedData).forEach(k => {
                const q = extractedData[k];
                cont.innerHTML += `
                    <div class="key-row" style="flex-direction:column; align-items:flex-start">
                        <b>Câu ${k}: ${q.content}</b>
                        <div style="display:flex; gap:10px; flex-wrap:wrap">
                            ${q.options.map(o => `<span style="background:#eee; padding:2px 8px; border-radius:4px">${o}</span>`).join('')}
                        </div>
                        <div style="color:green; font-weight:bold">Đúng: ${q.correct}</div>
                    </div>`;
            });
            status.innerHTML = "✅ Đã tách xong! Kiểm tra và Lưu.";
        } catch (e) {
            console.error(e);
            alert("Lỗi AI: " + e.message);
            status.innerText = "Lỗi. Thử lại.";
        } finally {
            btn.innerHTML = "AI Tách & Giải Đề"; btn.disabled = false;
        }
    }

    window.addAssignment = () => {
        if(!curClass || Object.keys(extractedData).length === 0) return alert("Chưa chọn lớp hoặc chưa có dữ liệu AI!");
        const title = document.getElementById('a-title').value;
        push(ref(db, `assignments/${curClass}`), {
            title: title,
            data: JSON.stringify(extractedData), // Lưu cấu trúc chi tiết
            timestamp: Date.now()
        });
        alert("Đã lưu bài tập!");
        quill.setText(""); document.getElementById('key-container').innerHTML = ""; extractedData = {};
    }

    // Logic Class/List (Giữ nguyên cơ bản)
    window.addClass = () => { const n = prompt("Tên lớp:"); if(n) push(ref(db, 'classes'), {name: n}); }
    onValue(ref(db, 'classes'), snap => {
        const l = document.getElementById('class-list'); l.innerHTML = "";
        const d = snap.val(); if(d) Object.keys(d).forEach(k => l.innerHTML += `<div class="class-item" onclick="curClass='${k}'; document.getElementById('manager').classList.remove('hidden'); document.getElementById('class-name').innerText='${d[k].name}'; loadAss('${k}')">${d[k].name}</div>`);
    });
    window.loadAss = (k) => {
        onValue(ref(db, `assignments/${k}`), snap => {
            const l = document.getElementById('list'); l.innerHTML = "";
            const d = snap.val(); if(d) Object.keys(d).reverse().forEach(aid => l.innerHTML += `<div style="background:white; padding:10px; margin:5px; border-radius:5px">${d[aid].title} <button onclick="delAss('${k}','${aid}')" style="float:right; color:red; border:none; background:none; cursor:pointer">Xóa</button></div>`);
        });
    }
    window.delAss = (c, a) => { if(confirm("Xóa?")) remove(ref(db, `assignments/${c}/${a}`)); }
</script>
</body>
</html>