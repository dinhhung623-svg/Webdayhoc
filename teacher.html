<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giáo Viên - AI Tách Đề (V24.1)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; background: #f0f2f5; }
        .sidebar { width: 280px; background: #2c3e50; color: white; display: flex; flex-direction: column; }
        .class-item { padding: 12px; margin: 5px; background: #34495e; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; color: white; transition: 0.2s;}
        .class-item:hover { background: #16a085; }
        .class-item.active { background: #e67e22; font-weight: bold; border-left: 5px solid white; } /* Hiệu ứng đã chọn */
        
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #ecf0f1; }
        .editor-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 1000px; margin: 0 auto 30px auto; }
        .ai-section { background: #e8f5e9; padding: 20px; border-radius: 12px; border: 1px solid #a5d6a7; margin-bottom: 25px; text-align: center; }
        .btn-ai { background: #43a047; color: white; padding: 12px 40px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 1.1em; transition: 0.3s; }
        .btn-ai:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(67, 160, 71, 0.3); }
        .btn-ai:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        #ai-status { margin-top: 15px; color: #1b5e20; font-weight: 500; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-primary { background: #2c3e50; color: white; padding: 15px; width: 100%; font-weight: bold; border:none; cursor: pointer; margin-top:15px; border-radius: 6px; font-size: 1.1em; }
        .btn-primary:hover { background: #34495e; }

        #editor-container { height: 250px; background: white; font-family: 'Times New Roman', serif; font-size: 1.1em; }
        .key-row { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px; background: #fafafa; padding: 15px; border: 1px solid #eee; border-radius: 8px; flex-direction: column; }
        .opt-tag { background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 15px; font-size: 0.9em; border: 1px solid #bbdefb; margin-right: 5px; margin-bottom: 5px; display: inline-block; }
        
        /* Highlight khi chưa chọn lớp */
        .blink-border { animation: blink 1s infinite; border: 2px solid red; }
        @keyframes blink { 50% { border-color: transparent; } }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="padding:20px; background:#1a252f; color:white;"><h3><i class="fas fa-chalkboard-teacher"></i> Giáo Viên</h3></div>
    <div id="class-list" style="padding:10px;"></div>
    <button onclick="addClass()" style="width:100%; padding:15px; background:#d35400; border:none; color:white; font-weight:bold; cursor:pointer;">+ Thêm Lớp Mới</button>
</div>

<div class="main-content">
    <div id="welcome-msg" style="text-align:center; color:#7f8c8d; margin-top: 100px;">
        <h2>⬅️ Vui lòng chọn một Lớp ở cột bên trái để bắt đầu</h2>
    </div>

    <div id="manager" class="hidden">
        <h2 style="color:#2c3e50; border-bottom: 2px solid #ddd; padding-bottom: 10px;">
            Lớp đang chọn: <span id="class-name" style="color:#e67e22">...</span>
        </h2>
        
        <div class="editor-box">
            <h3 style="margin-top:0; color:#2e7d32;"><i class="fas fa-file-word"></i> 1. Nhập đề thi (Copy từ Word/PDF)</h3>
            <p style="color:#666; font-size:0.9em">Dán toàn bộ nội dung câu hỏi và đáp án vào khung dưới đây.</p>
            <div id="editor-container"></div>
            
            <div class="ai-section" style="margin-top: 20px;">
                <input type="text" id="gemini-key-input" placeholder="Dán API Key Google Gemini vào đây (Nếu chưa lưu)" style="margin-bottom:10px;">
                <button id="btn-ai-trigger" class="btn-ai" onclick="processTextDetailed()">
                    <i class="fas fa-magic"></i> AI Tách & Giải Đề Ngay
                </button>
                <div id="ai-status">Sẵn sàng. Hãy dán đề và bấm nút trên.</div>
            </div>

            <h3 style="color:#2980b9; margin-top:30px;"><i class="fas fa-save"></i> 2. Lưu bài tập</h3>
            <input type="text" id="a-title" placeholder="Nhập tiêu đề bài tập (Ví dụ: Kiểm tra 15 phút)">
            
            <div style="margin-top: 20px;">
                <label><b>✅ Kết quả phân tích (Review):</b></label>
                <div id="key-container" style="margin-top:10px; border:1px solid #ddd; padding:15px; max-height:400px; overflow-y:auto; background:#f9f9f9; border-radius:6px;">
                    <div style="text-align:center; color:#999; padding: 20px;">Chưa có dữ liệu. Hãy bấm nút AI ở trên.</div>
                </div>
            </div>

            <button class="btn-primary" onclick="addAssignment()">LƯU BÀI TẬP VÀO LỚP NÀY</button>
        </div>
        
        <h3>Danh sách bài đã tạo:</h3>
        <div id="list"></div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    
    const firebaseConfig = { apiKey: "AIzaSyDjSb3byp5-SMUdJU5XDnGXwKEUOLXI6JE", authDomain: "lophoconl.firebaseapp.com", databaseURL: "https://lophoconl-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "lophoconl", storageBucket: "lophoconl.firebasestorage.app", messagingSenderId: "1051247561864", appId: "1:1051247561864:web:43886eee9886cafd59a33d" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    let curClass = null;
    let extractedData = {}; 

    var quill = new Quill('#editor-container', { 
        theme: 'snow', 
        placeholder: 'Ví dụ:\nCâu 1: Thủ đô của Việt Nam là?\nA. Hà Nội\nB. Huế\nC. Đà Nẵng\nD. Sài Gòn' 
    });

    // --- CHỌN LỚP ---
    window.selectClass = (k, name, el) => {
        curClass = k;
        document.getElementById('welcome-msg').classList.add('hidden');
        document.getElementById('manager').classList.remove('hidden');
        document.getElementById('class-name').innerText = name;
        
        // Highlight class item
        document.querySelectorAll('.class-item').forEach(i => i.classList.remove('active'));
        if(el) el.classList.add('active');
        
        loadAss(k);
    }

    // --- LOGIC AI TÁCH ĐỀ (MODEL FLASH 1.5 ỔN ĐỊNH) ---
    window.processTextDetailed = async () => {
        let key = document.getElementById('gemini-key-input').value.trim();
        if(!key) key = localStorage.getItem("MY_GEMINI_KEY");
        if(!key) return alert("⚠️ Vui lòng nhập API Key Google Gemini!");
        localStorage.setItem("MY_GEMINI_KEY", key);

        const text = quill.getText().trim();
        if(text.length < 10) return alert("⚠️ Vui lòng dán nội dung đề thi vào khung soạn thảo!");

        const btn = document.getElementById('btn-ai-trigger');
        const status = document.getElementById('ai-status');
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Đang phân tích...`; 
        btn.disabled = true;
        status.innerHTML = `<span style="color:#d35400">Đang đọc đề & tách đáp án A,B,C,D... (Vui lòng đợi)</span>`;

        // Prompt yêu cầu tách options
        const prompt = `
            Phân tích văn bản đề thi sau và chuyển thành JSON.
            Nhiệm vụ: Tách riêng nội dung câu hỏi và 4 đáp án (A, B, C, D) để hiển thị lên nút bấm.
            
            ĐỀ BÀI: """${text}"""
            
            OUTPUT JSON FORMAT:
            {
                "title": "Tên bài thi (tự đặt dựa trên nội dung)",
                "questions": {
                    "1": { 
                        "content": "Nội dung câu hỏi (không chứa đáp án)", 
                        "options": ["A. Đáp án 1", "B. Đáp án 2", "C. Đáp án 3", "D. Đáp án 4"], 
                        "correct": "A" 
                    },
                    "2": { ... }
                }
            }
            Lưu ý: "correct" là đáp án đúng (A, B, C, hoặc D) mà bạn suy luận được.
        `;

        try {
            // Dùng model 1.5-flash cho nhanh và ổn định
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            if(!resp.ok) throw new Error("Lỗi kết nối Google API (Check Key hoặc Mạng)");
            
            const data = await resp.json();
            const jsonStr = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            const result = JSON.parse(jsonStr);

            document.getElementById('a-title').value = result.title || "Bài tập mới";
            extractedData = result.questions;
            
            // Render Review
            const cont = document.getElementById('key-container');
            cont.innerHTML = "";
            if(!extractedData || Object.keys(extractedData).length === 0) {
                throw new Error("AI không tìm thấy câu hỏi nào.");
            }

            Object.keys(extractedData).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(k => {
                const q = extractedData[k];
                cont.innerHTML += `
                    <div class="key-row">
                        <div style="font-weight:bold; color:#333; margin-bottom:5px;">Câu ${k}: ${q.content}</div>
                        <div>
                            ${q.options.map(o => `<span class="opt-tag">${o}</span>`).join('')}
                        </div>
                        <div style="margin-top:5px; color:#27ae60; font-size:0.9em"><i class="fas fa-check-circle"></i> Đáp án đúng: <b>${q.correct}</b></div>
                    </div>`;
            });
            status.innerHTML = `<span style="color:#27ae60; font-weight:bold">✅ Đã tách thành công ${Object.keys(extractedData).length} câu! Hãy bấm Lưu.</span>`;
        } catch (e) {
            console.error(e);
            alert("Lỗi: " + e.message);
            status.innerHTML = `<span style="color:red">❌ Lỗi: ${e.message}</span>`;
        } finally {
            btn.innerHTML = `<i class="fas fa-magic"></i> AI Tách & Giải Đề Ngay`; 
            btn.disabled = false;
        }
    }

    // --- LƯU BÀI (CÓ CHECK LỖI KỸ) ---
    window.addAssignment = () => {
        // Check 1: Chưa chọn lớp
        if(!curClass) {
            alert("❌ BẠN CHƯA CHỌN LỚP!\nVui lòng bấm vào tên lớp ở cột bên trái.");
            document.querySelector('.sidebar').classList.add('blink-border');
            setTimeout(() => document.querySelector('.sidebar').classList.remove('blink-border'), 2000);
            return;
        }

        // Check 2: Chưa có data
        if(Object.keys(extractedData).length === 0) {
            alert("❌ CHƯA CÓ DỮ LIỆU ĐỀ THI!\nBạn hãy dán đề vào khung và bấm nút 'AI Tách & Giải Đề' màu xanh trước đã.");
            return;
        }

        const title = document.getElementById('a-title').value || "Bài tập không tên";
        
        push(ref(db, `assignments/${curClass}`), {
            title: title,
            data: JSON.stringify(extractedData), // Lưu full cấu trúc
            timestamp: Date.now()
        }).then(() => {
            alert("✅ Đã lưu bài tập thành công!");
            // Reset
            quill.setText(""); 
            document.getElementById('key-container').innerHTML = "<div style='text-align:center;color:#999;padding:20px'>Đã lưu xong. Sẵn sàng cho bài mới.</div>"; 
            extractedData = {};
            document.getElementById('a-title').value = "";
        }).catch(err => alert("Lỗi lưu DB: " + err));
    }

    // --- QUẢN LÝ LỚP ---
    window.addClass = () => { const n = prompt("Nhập tên lớp mới:"); if(n) push(ref(db, 'classes'), {name: n}); }
    
    onValue(ref(db, 'classes'), snap => {
        const l = document.getElementById('class-list'); l.innerHTML = "";
        const d = snap.val(); 
        if(d) Object.keys(d).forEach(k => {
            // Tạo phần tử lớp
            const div = document.createElement('div');
            div.className = 'class-item';
            div.innerHTML = `<span><i class="fas fa-users"></i> ${d[k].name}</span>`;
            div.onclick = function() { selectClass(k, d[k].name, this); };
            l.appendChild(div);
        });
    });

    window.loadAss = (k) => {
        onValue(ref(db, `assignments/${k}`), snap => {
            const l = document.getElementById('list'); l.innerHTML = "";
            const d = snap.val(); 
            if(!d) { l.innerHTML = "<p>Chưa có bài tập nào.</p>"; return; }
            
            Object.keys(d).reverse().forEach(aid => {
                l.innerHTML += `
                <div style="background:white; padding:15px; margin-bottom:10px; border-radius:8px; border-left:4px solid #3498db; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.05)">
                    <div>
                        <div style="font-weight:bold; font-size:1.1em">${d[aid].title}</div>
                        <div style="color:#7f8c8d; font-size:0.85em"><i class="far fa-clock"></i> ${new Date(d[aid].timestamp).toLocaleString()}</div>
                    </div>
                    <button onclick="delAss('${k}','${aid}')" style="color:#e74c3c; border:1px solid #e74c3c; background:none; padding:5px 10px; border-radius:4px; cursor:pointer"><i class="fas fa-trash"></i> Xóa</button>
                </div>`;
            });
        });
    }
    window.delAss = (c, a) => { if(confirm("Bạn chắc chắn muốn xóa bài này?")) remove(ref(db, `assignments/${c}/${a}`)); }
</script>
</body>
</html>