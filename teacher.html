<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi√°o Vi√™n - Upload Word AI üöÄ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; background: #f0f2f5; }
        .sidebar { width: 260px; background: #2c3e50; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .class-item { padding: 12px 15px; margin: 5px 10px; background: #34495e; border-radius: 6px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .class-item:hover { background: #16a085; }
        .class-item.active { background: #27ae60; border-left: 4px solid #fff; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #ecf0f1; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .tab-btn { padding: 10px 20px; border: none; background: #eee; border-radius: 20px; cursor: pointer; font-weight: bold; color: #555; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .tab-btn.active { background: #2980b9; color: white; box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3); }

        /* UPLOAD BOX */
        .upload-area {
            border: 2px dashed #3498db; background: #e3f2fd; border-radius: 10px;
            padding: 40px; text-align: center; cursor: pointer; transition: 0.3s;
        }
        .upload-area:hover { background: #bbdefb; }
        .upload-icon { font-size: 3em; color: #3498db; margin-bottom: 10px; }
        
        /* PREVIEW */
        .preview-box { margin-top: 20px; border: 1px solid #ddd; padding: 15px; max-height: 400px; overflow-y: auto; background: #fafafa; border-radius: 8px; display: none; }
        .q-item { background: white; padding: 10px; margin-bottom: 10px; border-left: 4px solid #2ecc71; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .q-essay { border-left-color: #e67e22; }

        .btn-save { background: #d35400; color: white; padding: 15px; width: 100%; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1em; cursor: pointer; margin-top: 20px; }
        .hidden { display: none; }
        .q-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="padding:20px; background:#1a252f; color:white;"><h3><i class="fas fa-chalkboard-teacher"></i> Gi√°o Vi√™n</h3></div>
    <div id="class-list" style="padding:10px;"></div>
    <div style="padding:10px"><button onclick="addClass()" style="width:100%; padding:12px; background:#e67e22; border:none; color:white; font-weight:bold; border-radius:4px;">+ L·ªõp M·ªõi</button></div>
</div>

<div class="main-content">
    <div id="welcome-msg" style="text-align:center; margin-top:100px; color:#7f8c8d;"><h2>‚¨ÖÔ∏è Ch·ªçn l·ªõp ƒë·ªÉ b·∫Øt ƒë·∫ßu</h2></div>

    <div id="manager" class="hidden container">
        <h2 style="margin-top:0; color:#2c3e50;">So·∫°n ƒê·ªÅ: <span id="class-name" style="color:#e67e22">...</span></h2>
        <input type="text" id="a-title" class="q-input" placeholder="T√™n b√†i thi (VD: ƒê·ªÅ thi th·ª≠ THPT)..." style="font-weight:bold; font-size:1.1em;">
        <input type="text" id="gemini-key" class="q-input" placeholder="API Key Google Gemini (B·∫Øt bu·ªôc)...">

        <div class="tabs">
            <button class="tab-btn active" onclick="switchMode('word')"><i class="fas fa-file-word"></i> Upload File Word (.docx)</button>
            <button class="tab-btn" onclick="alert('D√πng tab Upload Word ƒë·ªÉ x·ª≠ l√Ω file m·∫´u c·ªßa b·∫°n!')"><i class="fas fa-keyboard"></i> Th·ªß C√¥ng</button>
        </div>

        <div id="mode-word">
            <div class="upload-area" onclick="document.getElementById('file-input').click()">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <h3>B·∫•m ƒë·ªÉ ch·ªçn file Word (.docx)</h3>
                <p style="color:#666">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªçc ƒë·ªÅ tr·∫Øc nghi·ªám & t·ª± lu·∫≠n</p>
                <input type="file" id="file-input" accept=".docx" style="display:none" onchange="handleFile(this)">
            </div>
            
            <div id="status-msg" style="text-align:center; margin-top:10px; font-weight:bold; color:#2980b9;"></div>

            <div id="ai-preview" class="preview-box"></div>
        </div>

        <button class="btn-save" onclick="saveAssignment()">L∆ØU B√ÄI T·∫¨P</button>
        
        <div style="margin-top:30px;">
            <h3>Danh s√°ch b√†i ƒë√£ t·∫°o:</h3>
            <div id="list"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    
    const firebaseConfig = { apiKey: "AIzaSyDjSb3byp5-SMUdJU5XDnGXwKEUOLXI6JE", authDomain: "lophoconl.firebaseapp.com", databaseURL: "https://lophoconl-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "lophoconl", storageBucket: "lophoconl.firebasestorage.app", messagingSenderId: "1051247561864", appId: "1:1051247561864:web:43886eee9886cafd59a33d" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let curClass = null;
    let extractedData = {};

    // --- X·ª¨ L√ù FILE WORD (MAMMOTH + GEMINI) ---
    window.handleFile = (input) => {
        const file = input.files[0];
        if(!file) return;

        const key = document.getElementById('gemini-key').value.trim() || localStorage.getItem("MY_GEMINI_KEY");
        if(!key) return alert("Vui l√≤ng nh·∫≠p API Key tr∆∞·ªõc!");
        localStorage.setItem("MY_GEMINI_KEY", key);

        const status = document.getElementById('status-msg');
        status.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ƒêang ƒë·ªçc file Word...`;

        // 1. ƒê·ªçc file Word l·∫•y text th√¥
        const reader = new FileReader();
        reader.onload = function(e) {
            mammoth.extractRawText({arrayBuffer: e.target.result})
                .then(function(result){
                    const text = result.value; // Text th√¥ t·ª´ file Word
                    processWithAI(text, key);
                })
                .catch(function(err){
                    console.log(err);
                    status.innerHTML = `<span style="color:red">L·ªói ƒë·ªçc file: ${err.message}</span>`;
                });
        };
        reader.readAsArrayBuffer(file);
    }

    // 2. G·ª≠i cho AI ph√¢n t√≠ch
    async function processWithAI(text, key) {
        const status = document.getElementById('status-msg');
        status.innerHTML = `<i class="fas fa-robot"></i> AI ƒëang ph√¢n t√≠ch c·∫•u tr√∫c ƒë·ªÅ (Tr·∫Øc nghi·ªám/T·ª± lu·∫≠n)... Vui l√≤ng ƒë·ª£i 10-20s.`;

        // Prompt c·ª±c m·∫°nh ƒë·ªÉ x·ª≠ l√Ω ƒë·ªÅ h·ªón h·ª£p
        const prompt = `
            Ph√¢n t√≠ch ƒë·ªÅ thi sau v√† tr·∫£ v·ªÅ JSON.
            ƒê·ªÅ thi bao g·ªìm:
            1. Tr·∫Øc nghi·ªám (Ph√°t √¢m, Tr·ªçng √¢m, Ng·ªØ ph√°p): C√≥ 4 ƒë√°p √°n A, B, C, D.
            2. T·ª± lu·∫≠n (Vi·∫øt l·∫°i c√¢u, N·ªëi c√¢u): Kh√¥ng c√≥ ƒë√°p √°n ch·ªçn, h·ªçc sinh ph·∫£i t·ª± vi·∫øt.
            
            N·ªòI DUNG ƒê·ªÄ:
            """
            ${text}
            """
            
            Y√äU C·∫¶U OUTPUT JSON (Duy nh·∫•t):
            {
                "title": "T√™n ƒë·ªÅ thi (t·ª± ƒë·∫∑t)",
                "questions": {
                    "1": { 
                        "type": "mcq", 
                        "content": "N·ªôi dung c√¢u h·ªèi...", 
                        "options": ["A. ...", "B. ...", "C. ...", "D. ..."], 
                        "correct": "A" 
                    },
                    "2": { 
                        "type": "essay", 
                        "content": "N·ªôi dung c√¢u h·ªèi vi·∫øt l·∫°i c√¢u...",
                        "suggestion": "G·ª£i √Ω ƒë√°p √°n (n·∫øu c√≥)"
                    }
                }
            }
            L∆∞u √Ω: 
            - N·∫øu c√¢u h·ªèi c√≥ A, B, C, D -> type l√† "mcq".
            - N·∫øu c√¢u h·ªèi y√™u c·∫ßu vi·∫øt (Rewrite, Combine, Complete) -> type l√† "essay".
            - S·ªë th·ª© t·ª± c√¢u h·ªèi ph·∫£i li√™n t·ª•c.
        `;

        try {
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await resp.json();
            const jsonStr = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            const result = JSON.parse(jsonStr);

            extractedData = result.questions;
            if(result.title) document.getElementById('a-title').value = result.title;

            // Render Preview
            renderPreview(extractedData);
            status.innerHTML = `<span style="color:green">‚úÖ ƒê√£ ph√¢n t√≠ch xong! H√£y ki·ªÉm tra v√† L∆∞u.</span>`;

        } catch (e) {
            console.error(e);
            status.innerHTML = `<span style="color:red">L·ªói AI: ${e.message}. H√£y th·ª≠ l·∫°i.</span>`;
        }
    }

    function renderPreview(data) {
        const box = document.getElementById('ai-preview');
        box.style.display = 'block';
        box.innerHTML = "";
        
        Object.keys(data).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(k => {
            const q = data[k];
            let html = `<div class="q-item ${q.type === 'essay' ? 'q-essay' : ''}">`;
            html += `<b>C√¢u ${k} (${q.type === 'mcq' ? 'Tr·∫Øc nghi·ªám' : 'T·ª± lu·∫≠n'}):</b> ${q.content}`;
            
            if(q.type === 'mcq') {
                html += `<div style="margin-top:5px; font-size:0.9em; color:#555">`;
                q.options.forEach(o => html += `<span style="background:#eee; padding:2px 8px; margin-right:5px; border-radius:4px">${o}</span>`);
                html += `</div>`;
            } else {
                html += `<div style="margin-top:5px; font-style:italic; color:#e67e22">H·ªçc sinh s·∫Ω nh·∫≠p c√¢u tr·∫£ l·ªùi.</div>`;
            }
            html += `</div>`;
            box.innerHTML += html;
        });
    }

    window.saveAssignment = () => {
        if(!curClass || Object.keys(extractedData).length === 0) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu!");
        const title = document.getElementById('a-title').value || "B√†i t·∫≠p t·ª´ Word";
        
        push(ref(db, `assignments/${curClass}`), {
            title: title,
            data: JSON.stringify(extractedData),
            timestamp: Date.now()
        });
        alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
        document.getElementById('ai-preview').style.display = 'none';
        extractedData = {};
    }

    // C√°c h√†m qu·∫£n l√Ω l·ªõp (Gi·ªØ nguy√™n)
    window.addClass = () => { const n = prompt("T√™n l·ªõp:"); if(n) push(ref(db, 'classes'), {name: n}); }
    onValue(ref(db, 'classes'), snap => {
        const l = document.getElementById('class-list'); l.innerHTML = "";
        const d = snap.val(); if(d) Object.keys(d).forEach(k => {
            l.innerHTML += `<div class="class-item" onclick="curClass='${k}'; document.getElementById('manager').classList.remove('hidden'); document.getElementById('class-name').innerText='${d[k].name}'; loadAss('${k}')">${d[k].name}</div>`;
        });
    });
    window.loadAss = (k) => {
        onValue(ref(db, `assignments/${k}`), snap => {
            const l = document.getElementById('list'); l.innerHTML = "";
            const d = snap.val(); if(d) Object.keys(d).reverse().forEach(aid => {
                l.innerHTML += `<div style="background:white; padding:10px; margin-bottom:5px; border-radius:5px">${d[aid].title} <button onclick="remove(ref(db, 'assignments/${k}/${aid}'))" style="float:right;color:red;border:none;cursor:pointer">X√≥a</button></div>`;
            });
        });
    }
</script>
</body>
</html>